---
title: "Australian Wines Time Series Analysis"
format: html
---

```{r}
library(tidyverse)
library(fpp3)
library(gt)
library(urca)
```

### Data Import and Preparation

```{r}
aus_wine <- readr::read_csv(here::here("AustralianWines.csv"), na = "*",
                            col_types = cols(Rose = col_number()),
                            show_col_types = FALSE) |> 
    fill(Rose, .direction = "down") |> 
    mutate(Month = mdy(str_replace(Month, '-', '-01-')) |> yearmonth()) 

# Convert to Long Format Tsibble
aus_wine_ts <- aus_wine |> 
  pivot_longer(cols = -Month, names_to = "Varietal", values_to = "Sales") |> 
  as_tsibble(index = Month, key = Varietal) |> 
  mutate(Varietal = str_trim(Varietal))

# Quick check of the data structure
head(aus_wine_ts) |> gt()
```

###  Data Visualization

```{r}
# create a cutoff date for the vertical line (end of training: Dec 1993)
cutoff_date <- lubridate::ymd("1993-12-01") |> yearmonth()

# Data visualization with cutoff line
aus_wine_ts |> 
  autoplot(Sales) +
  facet_wrap(~Varietal, scales = "free_y", ncol = 2) +
  labs(title = "Australian Wine Sales by Varietal",
       y = "Sales Volume") +
  theme_minimal() +
  geom_vline(xintercept = cutoff_date, linetype = "dashed", color = "black", linewidth = 0.6)
```


### Model Fitting

```{r}
# Define Training/Validation Split
# use data up to end of 1993 for training, and keep 1994-1995 for validation
train_data <- aus_wine_ts |> 
  filter(Month <= cutoff_date)

# Fit Models
fit <- train_data |> 
  model(
    TSLM = TSLM(Sales ~ trend() + season()),
    ETS = ETS(Sales),
    ARIMA = ARIMA(Sales)
  )

# View the model details (Model Specs)
fit
```


### Training Accuracy 

```{r}
fit |> 
  accuracy() |>
  select(Varietal, .model, RMSE, MAE, MAPE) |>
  arrange(.model, RMSE) |>
  gt() |> fmt_number(decimals = 2)
```


### Forecast Accuracy

```{r}
# Forecast 12 months ahead
fc <- fit |> 
  forecast(h = "12 months")

# Calculate Accuracy on the Test Set 
accuracy_table <- accuracy(fc, aus_wine_ts) |> 
  select(Varietal, .model, RMSE, MAE, MAPE) |> 
  arrange(Varietal, RMSE)

# Display nicely with gt
accuracy_table |> 
  group_by(Varietal) |> 
  gt() |> 
  fmt_number(columns = c(RMSE, MAE, MAPE), decimals = 2) |> 
  tab_header(title = "Forecast Accuracy (Validation Set)")
```

### Forecast Visualization

```{r}
fc |> 
  autoplot(aus_wine_ts, level = 80) + # Show 80% prediction intervals
  facet_wrap(~Varietal, scales = "free_y", ncol = 2) +
  labs(title = "Forecast vs Actuals (Validation Period)",
       y = "Sales") +
  theme_minimal()
```

```{r}
# start one year before cutoff (same yearmonth class as Month)
trn_start <- yearmonth(cutoff_date |> as.Date() - years(1))

# plot forecasts using the aus_wine_ts tsibble (not `data`)
fc |>
  autoplot(aus_wine_ts |> filter(Month >= trn_start)) +
  labs(y = "Sales", title = "Varietal Sales forecasts") +
  facet_grid(Varietal ~ .model, scales = "free_y") +
  theme_minimal() +
  geom_vline(xintercept = as.Date(cutoff_date), linetype = "dashed", color = "black", linewidth = 0.6)
```

### Forecast Table

```{r}
# Forecast Table â€” use case-insensitive model match and format Month for headers
fc |>
  filter(tolower(.model) == "arima") |>            # match ARIMA regardless of case
  as_tibble() |>
  mutate(.mean = round(.mean, 0)) |>               # round forecast values
  select(Varietal, Month, .mean) |>
  pivot_wider(names_from = Month, values_from = .mean) |>
  gt() |> 
  fmt_number(columns = everything(), decimals = 0)
```