---
title: "Australian Wines Time Series Analysis"
format: html
---

```{r}
library(tidyverse)
library(fpp3)
library(gt)
library(urca)
```

## Tab1 - Visualizatoin

### Data Import and Preparation

```{r}
aus_wine <- readr::read_csv(here::here("AustralianWines.csv"), na = "*",
                            col_types = cols(Rose = col_number()),
                            show_col_types = FALSE) |> 
    fill(Rose, .direction = "down") |> 
    mutate(Month = mdy(str_replace(Month, '-', '-01-')) |> yearmonth()) 

# Convert to Long Format Tsibble
aus_wine_ts <- aus_wine |> 
  pivot_longer(cols = -Month, names_to = "Varietal", values_to = "Sales") |> 
  as_tsibble(index = Month, key = Varietal) |> 
  mutate(Varietal = str_trim(Varietal))

```


###  Data Visualization

```{r}
# create a cutoff date for the vertical line (end of training: Dec 1993)
cutoff_date <- lubridate::ymd("1993-12-01") |> yearmonth()

# Data visualization with cutoff line
aus_wine_ts |> 
  autoplot(Sales) +
  facet_wrap(~Varietal, scales = "free_y", ncol = 2) +
  labs(title = "Australian Wine Sales by Varietal",
       y = "Sales Volume") +
  theme_minimal() +
  geom_vline(xintercept = cutoff_date, linetype = "dashed", color = "black", linewidth = 0.6)
```

## Tab 2 - Model Building

Inputs:

* Toggle for model specificatoin (default off)
* Toggle Training accuracy (default off)

### Model Fitting

```{r}
# Define Training/Validation Split
# use data up to end of 1993 for training, and keep 1994-1995 for validation
train_data <- aus_wine_ts |> 
  filter(Month <= cutoff_date)

# Fit Models
fit <- train_data |> 
  model(
    TSLM = TSLM(Sales ~ trend() + season()),
    ETS = ETS(Sales),
    ARIMA = ARIMA(Sales)
  )

# View the model details (Model Specs)
fit
```


### Training Accuracy 

```{r}
fit |> 
  accuracy() |>
  select(Varietal, .model, RMSE, MAE, MAPE) |>
  arrange(.model, RMSE) |>
  gt() |> fmt_number(decimals = 2)
```


### Forecast Accuracy

```{r}
# Forecast 12 months ahead
fc <- fit |> 
  forecast(h = "12 months")

# Calculate Accuracy on the Test Set 
accuracy_table <- accuracy(fc, aus_wine_ts) |> 
  select(Varietal, .model, RMSE, MAE, MAPE) |> 
  arrange(Varietal, RMSE)

# Display nicely with gt
accuracy_table |> 
  group_by(Varietal) |> 
  gt() |> 
  fmt_number(columns = c(RMSE, MAE, MAPE), decimals = 2) |> 
  tab_header(title = "Forecast Accuracy (Validation Set)")
```

## Tab3 - Forecast

Inputs:

* Select the model for the Forecast table

### Forecast Visualization

```{r}
fc |> 
  autoplot(aus_wine_ts, level = 80) + # Show 80% prediction intervals
  facet_wrap(~Varietal, scales = "free_y", ncol = 2) +
  labs(title = "Forecast vs Actuals (Validation Period)",
       y = "Sales") +
  theme_minimal()
```

```{r}
# start one year before cutoff (same yearmonth class as Month)
trn_start <- yearmonth(cutoff_date |> as.Date() - years(1))

# plot forecasts using the aus_wine_ts tsibble (not `data`)
fc |>
  autoplot(aus_wine_ts |> filter(Month >= trn_start)) +
  labs(y = "Sales", title = "Varietal Sales forecasts") +
  facet_grid(Varietal ~ .model, scales = "free_y") +
  theme_minimal() +
  geom_vline(xintercept = as.Date(cutoff_date), linetype = "dashed", color = "black", linewidth = 0.6)
```

### Forecast Table

```{r}
# Forecast Table â€” use case-insensitive model match and format Month for headers
fc |>
  filter(tolower(.model) == "arima") |>            # match ARIMA regardless of case
  as_tibble() |>
  mutate(.mean = round(.mean, 0)) |>               # round forecast values
  select(Varietal, Month, .mean) |>
  pivot_wider(names_from = Month, values_from = .mean) |>
  gt() |> 
  fmt_number(columns = everything(), decimals = 0)
```

## Tab4 - About
This Australian Wines Time Series Analysis Quarto document provides a comprehensive overview of the sales trends of various wine varietals in Australia. The analysis includes data visualization, model building, forecast accuracy evaluation, and detailed forecasting. 

The document is structured into four main tabs: Visualization, Model Building, Forecast, and About. Each tab offers insights into different aspects of the time series analysis, from initial data exploration to advanced forecasting techniques.

The analysis utilizes R programming language and several powerful libraries, including `tidyverse` for data manipulation, `fpp3` for time series analysis, and `gt` for creating elegant tables. The dataset used in this analysis is sourced from "AustralianWines.csv", which contains monthly sales data for various wine varietals.

The Visualization tab presents the sales trends of different wine varietals over time, allowing for easy comparison and identification of seasonal patterns. The Model Building tab focuses on fitting various time series models, such as TSLM, ETS, and ARIMA, to the training data and evaluating their accuracy on a validation set. The Forecast tab provides visualizations of the forecasts generated by the selected models and presents a detailed forecast table for further analysis.

The document is designed to be interactive, allowing users to toggle model specifications and view training accuracy as needed. This flexibility enhances the user experience and provides deeper insights into the time series analysis process.

How to replicate the analysis:
1. Ensure you have R and RStudio installed on your machine.
2. Install the required packages: `tidyverse`, `fpp3`, `gt`, and `urca`.
3. Download the "AustralianWines.csv" dataset and place it in your working directory.
4. Open this Quarto document in RStudio and run the code chunks sequentially to replicate the analysis.

How to interpret the results:
- The visualizations in the Visualization tab help identify trends and seasonal patterns in wine sales.
- The Model Building tab provides insights into the performance of different time series models, with accuracy metrics such as RMSE, MAE, and MAPE indicating how well each model fits the data.
- The Forecast tab allows users to visualize the forecasts against actual sales data and provides a detailed forecast table for further analysis.

How to customize the analysis:
- Users can modify the model specifications in the Model Building tab to explore different modeling approaches.
- The forecast horizon can be adjusted in the Forecast tab to generate forecasts for different time periods.

How to reproduce the figures and tables:
- The figures and tables in this document are generated using R code chunks. Users can modify the code to customize the visualizations and tables according to their preferences.
- To reproduce the figures and tables, simply run the corresponding code chunks in RStudio.

